---
- block:
    - set_fact: nvim=true
    - file: path="~/.config/nvim" state=directory
    - template: src="vimrc" dest="~/.config/nvim/init.vim"
  always:
    - set_fact: nvim=false

- file: path="~/bin" state=directory mode=0755

- template: src="myvi" dest="~/bin/myvi" mode=0755
- template: src="vit" dest="~/bin/vit" mode=0755

- git: repo=https://github.com/gmarik/vundle.git
       dest=~/.vim/bundle/vundle
       depth=1
       force=yes

- git: repo=https://github.com/powerline/powerline
       dest=~/.powerline
       depth=1

- template: src="vimrc" dest="~/.vimrc"

- block:
    - name: clone YouCompleteMe first
      git: repo=https://github.com/Valloric/YouCompleteMe
           dest=~/.vim/bundle/YouCompleteMe/
           depth=1
           force=yes
      when: programming == true

    - name: install YouCompleteMe
      shell: ~/.vim/bundle/YouCompleteMe/install.py --clang-completer
      args:
        creates: ~/.vim/ycm_installed
      register: command_result
      when: programming == true

    - name: mark ycm installed
      shell: touch ~/.vim/ycm_installed
      when: programming == true
  rescue:
    - name: remove YouCompleteMe plugin when failed to compile
      lineinfile: dest="~/.vimrc"
                  state=absent
                  regexp="Bundle 'Valloric/YouCompleteMe'"
      when: programming == true


- shell: "vim +PluginInstall +qall now"

- shell: "getent passwd $LOGNAME | cut -d: -f7"
  register: default_shell

- lineinfile: dest="~/.vimrc"
              regexp="set shell"
              line="set shell={{ default_shell.stdout }}"

- name: make VimShell
  shell: make
  args:
    chdir: ~/.vim/bundle/vimproc.vim
    creates: ~/.vim/vimshell_installed
  when: programming == true

